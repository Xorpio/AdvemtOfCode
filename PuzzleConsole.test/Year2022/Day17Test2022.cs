using PuzzleConsole.Year2022.Day17;

namespace PuzzleConsole.test.Year2022;

[Trait("Year", "2022")]
[Trait("Day", "17")]
public partial class Day17Test2022 {
    [Scenario]
    public void SolveTest(ScenarioContext scenario)
    {
        var sut = new Day17();

        var sampleInput = """
        >>><<><>><<<>><>>><<<>>><<<><<<>><>><<>>
        """;
        var lines = sampleInput.Split("\n").Select(s => s.Trim()).ToArray();

        scenario.Fact("Sut should not be null", () =>
        {
            sut.Should().NotBeNull();
        });

        var tetris = new Tetris(sampleInput);

        var inputs = new (int rounds, int ceiling)[]
        {
            (1, 1),
            (2, 4),
            (3, 6),
            (4, 7),
            (5, 9),
            (6, 10),
            (7, 13),
            (8, 15),
            (9, 17),
            (10, 17),
            (2022, 3068),
        };

        foreach (var inp in inputs)
        {
            scenario.Theory("Test Tetris", inp, () =>
            {
                tetris.Play(inp.rounds);
                tetris.Ceiling.Should().Be(inp.ceiling);
            });
        }

        scenario.Fact("Small sample test", () =>
        {
            sut.Solve(lines)[0].Should().Be("3068");
        });

        var start = new double[]{1,3,3,0,2,1,2,3,2,2,1,3,3,0,2,1,2,3,0,0,1,3,3,2,0,1,2,1,4,0,0,2,2,0,2,0,3,2,2,2,1,2,3,4,2,1,2,3,0,1,1,3,3,2,2,1,3,2,1,2,1,3,0,0,2,1,0,2,2,0,1,3,2,0,0,1,3,3,4,0,1,3,2,0,0,0,2,2,4,0,1,2,2,2,0,1,3,3,0,0,1,3,3,4,2,1,3,3,0,0,1,3,2,2,2,0,0,3,2,0,1,3,3,0,0,1,2,3,0,0,1,2,3,2,0,1,3,3,2,0,0,2,3,0,2,1,3,0,2,0,1,3,3,0,2,1,3,3,4,0,1,3,3,4,0,1,3,3,0,2,1,3,3,0,0,1,3,0,3,2,1,3,3,0,0,1,3,3,0,2,0,3,3,2,0,1,2,2,4,2,1,2,3,4,0,1,3,3,2,0,1,2,3,0,0,1,3,3,2,0,1,3,3,2,2,1,3,3,4,2,1,3,3,0,2,1,2,2,4,2,0,0,3,2,2,1,3,2,2,0,1,2,1,2,2,1,1,2,2,2,0,3,0,0,1,1,1,2,4,2,1,2,1,2,0,1,3,3,2,0,1,3,3,2,0,1,3,3,2,2,1,3,3,0,0,1,1,2,2,2,0,0,3,4,0,0,3,3,0,0,0,3,3,4,0,1,0,3,0,2,1,3,3,0,0,1,3,3,2,0,1,3,0,0,2,1,3,2,2,0,1,2,3,4,2,1,2,1,2,2,1,3,3,0,2,1,3,3,0,0,0,2,2,2,0,1,2,3,0,1,1,3,2,0,0,1,2,3,4,0,1,3,2,0,0,1,3,3,0,2,1,3,0,3,0,1,2,3,2,0,1,3,2,2,0,1,3,0,4,0,1,3,3,0,0,1,3,3,2,2,1,3,2,1,1,1,3,2,1,1,1,2,3,0,1};
        var repeat = new double[]{1,2,2,4,2,1,3,3,0,0,1,3,2,2,0,1,3,2,4,0,1,2,1,2,0,1,3,2,2,2,1,3,3,0,0,0,3,0,0,1,1,3,0,3,2,0,0,2,2,2,1,2,2,2,0,0,2,3,0,2,1,3,2,0,0,0,2,1,4,0,1,3,3,2,0,1,3,3,2,0,1,3,3,2,0,1,3,3,2,2,1,0,3,0,0,1,3,2,4,0,0,0,3,0,0,1,3,2,2,0,1,3,3,0,2,1,3,2,0,0,0,2,2,2,0,1,2,2,0,2,1,3,3,0,0,1,3,2,2,0,1,2,3,0,2,1,3,3,4,2,0,0,0,3,2,1,3,3,2,2,1,3,2,2,0,1,2,2,1,0,0,2,3,0,0,1,2,3,4,0,1,2,3,0,0,1,3,3,0,0,1,3,0,3,2,1,3,2,1,2,1,3,3,4,2,1,3,2,2,0,1,3,2,0,0,1,3,2,0,0,1,3,2,2,0,1,3,3,2,2,1,3,2,4,0,1,2,3,0,0,0,3,2,2,0,1,2,1,3,2,1,2,1,2,2,1,3,3,4,2,1,3,3,2,2,1,0,3,2,0,0,2,1,4,2,1,3,0,4,2,1,2,3,0,0,1,2,1,2,0,0,3,0,4,0,1,3,2,2,0,1,3,3,2,2,0,0,3,4,2,1,2,1,3,0,1,3,3,2,2,1,0,3,2,2,1,3,2,0,1,0,1,2,1,0,0,3,3,0,0,0,2,2,2,0,1,3,2,2,2,1,2,3,0,0,0,2,1,1,0,1,2,2,2,2,0,3,0,3,0,0,0,3,0,0,1,2,3,0,0,1,3,3,0,0,1,2,1,3,0,1,3,3,2,2,1,2,1,2,0,1,3,3,0,0,1,3,3,0,0,0,2,1,2,0,1,3,3,2,0,0,2,3,0,2,1,3,0,0,2,0,2,1,0,2,1,2,1,3,2,0,0,3,0,0,1,3,2,0,0,1,3,3,0,0,1,3,3,0,0,1,2,3,0,0,1,3,2,2,0,0,2,1,2,0,1,2,3,0,0,1,2,2,4,0,1,3,2,0,2,1,3,2,2,0,1,3,3,4,0,1,3,2,2,2,1,3,0,3,0,0,3,0,3,0,0,3,3,4,0,0,0,3,0,0,1,2,3,2,2,1,2,1,0,1,1,2,3,2,2,1,0,3,2,2,1,3,3,4,0,1,2,3,4,2,1,3,2,2,2,1,3,3,0,0,1,3,0,2,2,1,3,3,2,0,1,3,3,2,0,1,3,3,4,0,0,3,3,4,0,1,2,2,2,2,1,3,3,2,2,1,2,3,0,2,1,0,0,2,2,0,0,3,2,2,1,3,2,4,0,1,3,3,0,0,1,2,3,2,2,1,3,3,4,0,1,2,2,1,2,0,1,2,2,2,1,3,2,2,0,1,2,1,2,2,1,3,3,2,2,1,3,3,2,0,1,3,2,1,2,1,3,3,0,0,0,2,1,2,0,0,3,3,0,2,1,3,2,0,0,1,2,3,0,0,1,3,3,2,0,1,3,3,2,0,1,0,3,2,0,1,2,1,3,0,0,1,2,2,2,1,3,3,4,0,1,2,1,3,0,1,3,3,0,0,1,3,3,0,2,1,3,0,3,0,0,3,3,0,2,1,3,2,0,0,1,3,2,0,1,0,1,2,1,0,0,2,3,0,0,1,3,3,2,2,1,3,2,0,2,1,3,3,2,2,1,3,0,2,0,1,3,3,0,2,1,2,3,2,0,1,3,3,2,0,1,2,2,0,0,1,3,3,4,0,1,3,3,4,0,1,3,3,0,0,1,3,2,2,2,0,0,1,0,2,1,2,3,0,0,1,2,3,4,0,1,3,0,0,2,0,3,2,0,2,1,3,3,0,0,0,2,2,1,0,1,3,3,2,2,1,3,2,2,0,1,3,0,2,2,1,2,2,2,0,1,3,0,2,2,1,3,3,2,2,1,3,3,2,2,1,2,1,2,0,1,3,3,2,0,0,2,1,3,0,0,1,2,0,0,1,3,2,0,0,1,2,1,2,2,1,3,2,2,2,1,2,3,0,1,1,2,3,0,1,1,3,2,0,2,0,3,0,0,1,1,0,3,0,2,1,2,2,2,0,0,2,2,1,0,1,3,0,2,2,0,3,3,4,0,1,3,3,0,2,1,3,2,4,0,1,3,3,0,0,1,3,3,2,0,1,3,3,4,0,0,0,3,2,2,1,3,0,3,0,0,2,3,2,2,1,2,3,0,2,1,3,3,2,2,1,2,3,0,2,1,3,3,2,2,1,3,2,0,2,1,3,3,4,2,1,3,3,0,0,1,3,2,0,0,0,2,3,2,2,1,3,2,2,0,1,2,1,3,0,1,2,1,2,0,0,2,2,0,0,1,2,3,4,2,1,2,1,2,0,1,3,3,4,0,1,3,2,2,2,0,2,3,0,0,0,3,0,3,0,0,3,3,4,0,0,0,3,0,0,1,2,3,2,0,1,3,3,0,0,1,2,2,2,0,1,3,3,0,0,1,2,1,2,2,1,3,3,4,0,0,2,3,4,0,1,3,2,2,0,1,3,2,0,0,1,3,2,0,0,1,2,3,4,2,0,0,0,0,1,1,2,3,0,1,1,3,3,4,0,0,0,3,4,2,1,3,2,1,2,0,2,3,2,2,1,3,0,0,0,0,3,0,3,0,1,3,2,4,2,1,3,0,2,0,1,2,3,0,2,1,0,3,2,0,1,3,3,0,2,1,3,2,0,0,1,2,2,2,0,1,2,3,0,2,1,3,3,2,0,1,3,2,2,2,1,2,3,2,0,0,0,3,2,0,1,3,2,0,2,1,3,3,0,0,0,2,3,2,0,1,2,1,2,0,0,2,2,2,2,1,3,2,4,0,0,0,3,4,0,0,3,3,0,0,0,2,2,2,0,1,3,2,1,1,0,3,3,2,0,1,3,3,0,0,1,3,0,1,0,0,3,0,2,0,1,3,0,3,0,1,3,2,0,2,0,3,2,4,0,1,0,3,1,1,1,3,2,4,0,0,0,3,0,1,1,2,1,3,0,0,2,2,0,0,1,3,3,0,0,1,3,3,2,2,1,2,3,4,0,1,2,3,0,2,1,3,3,0,0,1,2,3,0,1,0,2,3,0,0,1,3,2,2,0,0,2,2,2,0,1,3,0,1,2,1,2,2,0,0,1,3,2,2,2,1,2,1,2,0,1,3,0,3,0,0,2,0,0,2,1,3,3,0,0,1,3,3,2,2,1,3,2,0,0,1,3,3,0,0,0,1,2,1,2,0,1,2,1,0,1,3,0,2,0,1,2,3,2,0,0,2,2,4,2,1,3,2,0,0,1,3,0,2,0,1,2,3,4,0,1,3,0,2,0,1,2,3,2,0,1,2,2,0,0,1,1,2,1,0,1,3,3,0,2,1,3,3,0,0,1,1,2,2,0,1,3,2,0,2,1,3,3,0,2,1,3,2,4,0,0,0,3,0,2,0,2,2,4,0,1,3,2,2,0,1,3,2,2,0,1,2,2,0,0,1,3,3,4,0,0,2,3,0,0,0,2,3,2,0,0,2,2,2,0,1,3,2,1,2,1,3,2,2,2,1,3,3,4,0,0,0,3,0,0,1,3,3,0,0,0,2,1,3,0,1,3,3,2,2,1,3,3,2,2,1,2,3,0,2,1,2,3,2,0,1,2,1,2,2,1,3,2,0,0,1,3,3,0,2,1,3,2,2,0,1,2,1,2,0,1,1,2,2,0,1,3,3,0,0,1,3,3,0,0,1,2,2,4,2,1,3,3,0,0,1,3,2,2,0,1,3,2,4,0,1,2,1,2,0,1,3,2,2,2,1,3,3,0,0,0,3,0,0,1,1,3,0,3,2,0,0,2,2,2,1,2,2,2,0,0,2,3,0,2,1,3,2,0,0,0,2,1,4,0,1,3,3,2,0,1,3,3,2,0,1,3,3,2,0,1,3,3,2,2,1,0,3,0,0,1,3,2,4,0,0,0,3,0,0,1,3,2,2,0,1,3,3,0,2,1,3,2,0,0,0,2,2,2,0,1,2,2,0,2,1,3,3,0,0,1,3,2,2,0,1,2,3,0,2,1,3,3,4,2,0,0,0,3,2,1,3,3,2,2,1,3,2,2,0,1,2,2,1,0,0,2,3,0,0,1,2,3,4,0,1,2,3,0,0,1,3,3,0,0,1,3,0,3,2,1,3,2,1,2,1,3,3,4,2,1,3,2,2,0,1,3,2,0,0,1,3,2,0,0,1,3,2,2,0,1,3,3,2,2,1,3,2,4,0,1,2,3,0,0,0,3,2,2,0,1,2,1,3,2,1,2,1,2,2,1,3,3,4,2,1,3,3,2,2,1,0,3,2,0,0,2,1,4,2,1,3,0,4,2,1,2,3,0,0,1,2,1,2,0,0,3,0,4,0,1,3,2,2,0,1,3,3,2,2,0,0,3,4,2,1,2,1,3,0,1,3,3,2,2,1,0,3,2,2,1,3,2,0,1,0,1,2,1,0,0,3,3,0,0,0,2,2,2,0,1,3,2,2,2,1,2,3,0,0,0,2,1,1,0,1,2,2,2,2,0,3,0,3,0,0,0,3,0,0,1,2,3,0,0,1,3,3,0,0,1,2,1,3,0,1,3,3,2,2,1,2,1,2,0,1,3,3,0,0,1,3,3,0,0,0,2,1,2,0,1,3,3,2,0,0,2,3,0,2,1,3,0,0,2,0,2,1,0,2,1,2,1,3,2,0,0,3,0,0,1,3,2,0,0,1,3,3,0,0,1,3,3,0,0,1,2,3,0,0,1,3,2,2,0,0,2,1,2,0,1,2,3,0,0,1,2,2,4,0,1,3,2,0,2,1,3,2,2,0,1,3,3,4,0,1,3,2,2,2,1,3,0,3,0,0,3,0,3,0,0,3,3,4,0,0,0,3,0,0,1,2,3,2,2,1,2,1,0,1,1,2,3,2,2,1,0,3,2,2,1,3,3,4,0,1,2,3,4,2,1,3,2,2,2,1,3,3,0,0,1,3,0,2,2,1,3,3,2,0,1,3,3,2,0,1,3,3,4,0,0,3,3,4,0,1,2,2,2,2,1,3,3,2,2,1,2,3,0,2,1,0,0,2,2,0,0,3,2,2,1,3,2,4,0,1,3,3,0,0,1,2,3,2,2,1,3,3,4,0,1,2,2,1,2,0,1,2,2,2,1,3,2,2,0,1,2,1,2,2,1,3,3,2,2,1,3,3,2,0,1,3,2,1,2,1,3,3,0,0,0,2,1,2,0,0,3,3,0,2,1,3,2,0,0,1,2,3,0,0,1,3,3,2,0,1,3,3,2,0,1,0,3,2,0,1,2,1,3,0,0,1,2,2,2,1,3,3,4,0,1,2,1,3,0,1,3,3,0,0,1,3,3,0,2,1,3,0,3,0,0,3,3,0,2,1,3,2,0,0,1,3,2,0,1,0,1,2,1,0,0,2,3,0,0,1,3,3,2,2,1,3,2,0,2,1,3,3,2,2,1,3,0,2,0,1,3,3,0,2,1,2,3,2,0,1,3,3,2,0,1,2,2,0,0,1,3,3,4,0,1,3,3,4,0,1,3,3,0,0,1,3,2,2,2,0,0,1,0,2,1,2,3,0,0,1,2,3,4,0,1,3,0,0,2,0,3,2,0,2,1,3,3,0,0,0,2,2,1,0,1,3,3,2,2,1,3,2,2,0,1,3,0,2,2,1,2,2,2,0,1,3,0,2,2,1,3,3,2,2,1,3,3,2,2,1,2,1,2,0,1,3,3,2,0,0,2,1,3,0,0,1,2,0,0,1,3,2,0,0,1,2,1,2,2,1,3,2,2,2,1,2,3,0,1,1,2,3,0,1,1,3,2,0,2,0,3,0,0,1,1,0,3,0,2,1,2,2,2,0,0,2,2,1,0,1,3,0,2,2,0,3,3,4,0,1,3,3,0,2,1,3,2,4,0,1,3,3,0,0,1,3,3,2,0,1,3,3,4,0,0,0,3,2,2,1,3,0,3,0,0,2,3,2,2,1,2,3,0,2,1,3,3,2,2,1,2,3,0,2,1,3,3,2,2,1,3,2,0,2,1,3,3,4,2,1,3,3,0,0,1,3,2,0,0,0,2,3,2,2,1,3,2,2,0,1,2,1,3,0,1,2,1,2,0,0,2,2,0,0,1,2,3,4,2,1,2,1,2,0,1,3,3,4,0,1,3,2,2,2,0,2,3,0,0,0,3,0,3,0,0,3,3,4,0,0,0,3,0,0,1,2,3,2,0,1,3,3,0,0,1,2,2,2,0,1,3,3,0,0,1,2,1,2,2,1,3,3,4,0,0,2,3,4,0,1,3,2,2,0,1,3,2,0,0,1,3,2,0,0,1,2,3,4,2,0,0,0,0,1,1,2,3,0,1,1,3,3,4,0,0,0,3,4,2,1,3,2,1,2,0,2,3,2,2,1,3,0,0,0,0,3,0,3,0,1,3,2,4,2,1,3,0,2,0,1,2,3,0,2,1,0,3,2,0,1,3,3,0,2,1,3,2,0,0,1,2,2,2,0,1,2,3,0,2,1,3,3,2,0,1,3,2,2,2,1,2,3,2,0,0,0,3,2,0,1,3,2,0,2,1,3,3,0,0,0,2,3,2,0,1,2,1,2,0,0,2,2,2,2,1,3,2,4,0,0,0,3,4,0,0,3,3,0,0,0,2,2,2,0,1,3,2,1,1,0,3,3,2,0,1,3,3,0,0,1,3,0,1,0,0,3,0,2,0,1,3,0,3,0,1,3,2,0,2,0,3,2,4,0,1,0,3,1,1,1,3,2,4,0,0,0,3,0,1,1,2,1,3,0,0,2,2,0,0,1,3,3,0,0,1,3,3,2,2,1,2,3,4,0,1,2,3,0,2,1,3,3,0,0,1,2,3,0,1,0,2,3,0,0,1,3,2,2,0,0,2,2,2,0,1,3,0,1,2,1,2,2,0,0,1,3,2,2,2,1,2,1,2,0,1,3,0,3,0,0,2,0,0,2,1,3,3,0,0,1,3,3,2,2,1,3,2,0,0,1,3,3,0,0,0,1,2,1,2,0,1,2,1,0,1,3,0,2,0,1,2,3,2,0,0,2,2,4,2,1,3,2,0,0,1,3,0,2,0,1,2,3,4,0,1,3,0,2,0,1,2,3,2,0,1,2,2,0,0,1,1,2,1,0,1,3,3,0,2,1,3,3,0,0,1,1,2,2,0,1,3,2,0,2,1,3,3,0,2,1,3,2,4,0,0,0,3,0,2,0,2,2,4,0,1,3,2,2,0,1,3,2,2,0,1,2,2,0,0,1,3,3,4,0,0,2,3,0,0,0,2,3,2,0,0,2,2,2,0,1,3,2,1,2,1,3,2,2,2,1,3,3,4,0,0,0,3,0,0,1,3,3,0,0,0,2,1,3,0,1,3,3,2,2,1,3,3,2,2,1,2,3,0,2,1,2,3,2,0,1,2,1,2,2,1,3,2,0,0,1,3,3,0,2,1,3,2,2,0,1,2,1,2,0,1,1,2,2,0,1,3,3,0,0,1,3,3,0,0};

        double startRepeat = start.Length;

        double rounds = 1_000_000_000_000;
        var repeats = Math.Floor((rounds - startRepeat) / repeat.Length);
        var sum = repeat.Sum();

        double count = start.Sum();
        var iterations = repeats * sum;

        count += iterations;

        var left = rounds - startRepeat - (repeats * repeat.Length);

        count += repeat[0..(int)left].Sum();
    }
}